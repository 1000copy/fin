//
//  AnalyzeURLHelper.swift
//  V2ex-Swift
//
//  Created by huangfeng on 2/18/16.
//  Copyright © 2016 Fin. All rights reserved.
//

import UIKit

class AnalyzeURLHelper {
    /**
     分析URL 进行相应的操作

     - parameter url: 各种URL 例如https://baidu.com 、/member/finab 、/t/100000
     */
    @discardableResult
    class func Analyze(_ url:String) -> Bool {
        let result = AnalyzURLResultType(url: url)
        switch result {
            
        case .url(let url):
            url.run()
            
        case .member(let member):
            member.run()
            
        case .topic(let topic):
            topic.run()
            
        case .undefined :
            return false
        }
        
        return true
    }
}

enum AnalyzURLResultType {
    /// 普通URL链接
    case url(UrlActionModel)
    /// 用户
    case member(MemberActionModel)
    /// 帖子链接
    case topic(TopicActionModel)
    /// 未定义
    case undefined
    
    private enum `Type` : Int {
        case url, member, topic , undefined
    }
    
    private static let patterns = [
        "^(http|ftp|https):\\/\\/[\\w\\-_]+(\\.[\\w\\-_]+)+([\\w\\-\\.,@?^=%&amp;:/~\\+#]*[\\w\\-\\@?^=%&amp;/~\\+#])?",
        "^(http:\\/\\/|https:\\/\\/)?(www\\.)?(v2ex.com)?/member/[a-zA-Z0-9_]+$",
        "^(http:\\/\\/|https:\\/\\/)?(www\\.)?(v2ex.com)?/t/[0-9]+",
        ]
    
    init(url:String) {
        var resultType:AnalyzURLResultType = .undefined
        
        var type = Type.undefined
        for pattern in AnalyzURLResultType.patterns {
            let regex = try! NSRegularExpression(pattern: pattern, options: .caseInsensitive)
            regex.enumerateMatches(in: url, options: .withoutAnchoringBounds, range: NSMakeRange(0, url.Lenght), using: { (result, _, _) -> Void in
                if let result = result {
                    let range = result.range
                    if range.location == NSNotFound || range.length <= 0 {
                        return ;
                    }
                    
                    type = Type(rawValue: AnalyzURLResultType.patterns.index(of: pattern)!)!
                    
                    switch type {
                    case .url:
                        if let action = UrlActionModel(url: url) {
                            resultType = .url(action)
                        }
                        
                    case .member :
                        if let action = MemberActionModel(url: url) {
                            resultType = .member(action)
                        }
                        
                    case .topic:
                        if let action = TopicActionModel(url: url) {
                            resultType = .topic(action)
                        }
                        
                    default:break
                    }
                }
            })
        }
        
        self = resultType
    }
}

protocol AnalyzeURLActionProtocol {
    init?(url:String)
    func run()
}

struct UrlActionModel: AnalyzeURLActionProtocol{
    var url:String
    init?(url:String) {
        self.url = url;
    }
    func run() {
        let controller = V2WebViewViewController(url: url)
        V2Client.sharedInstance.topNavigationController.pushViewController(controller, animated: true)
    }
}

struct MemberActionModel: AnalyzeURLActionProtocol {
    var username:String
    init?(url:String) {
        if  let range = url.range(of: "/member/") {
            self.username = url.substring(from: range.upperBound)
        }
        else{
            return nil
        }
    }
    func run() {
        let memberViewController = MemberViewController()
        memberViewController.username = username
        V2Client.sharedInstance.topNavigationController.pushViewController(memberViewController, animated: true)
    }
}

struct TopicActionModel: AnalyzeURLActionProtocol {
    var topicID:String
    init?(url:String) {
        if  let range = url.range(of: "/t/") {
            var topicID = url.substring(from: range.upperBound)
            
            if let range = topicID.range(of: "?"){
                topicID = topicID.substring(to: range.lowerBound)
            }
            
            if let range = topicID.range(of: "#"){
                topicID = topicID.substring(to: range.lowerBound)
            }
            self.topicID = topicID
        }
        else{
            return nil;
        }
    }
    func run() {
        let controller = TopicDetailViewController()
        controller.topicId = topicID
        V2Client.sharedInstance.topNavigationController.pushViewController(controller, animated: true)
    }
}


extension AnalyzeURLHelper {
    /**
     测试
     */
    class func test() -> Void {
        var urls  = [
            "http://v2ex.com/member/finab",
            "https://v2ex.com/member/finab",
            "http://www.v2ex.com/member/finab",
            "https://www.v2ex.com/member/finab",
            "v2ex.com/member/finab",
            "www.v2ex.com/member/finab",
            "/member/finab",
            "/MEMBER/finab"
        ]
        urls.forEach { (url) in
            let result = AnalyzURLResultType(url: url)
            if case AnalyzURLResultType.member(let member) = result {
                print(member.username)
            }
            else{
                assert(false, "不能解析member : " + url )
            }
            
        }
        
        urls = [
            "member/finab",
            "www.baidu.com/member/finab",
            "com/member/finab",
            "www.baidu.com",
            "http://www.baidu.com"
        ]
        urls.forEach { (url) in
            let result = AnalyzURLResultType(url: url)
            if case AnalyzURLResultType.member(_) = result {
                assert(true, "解析了不是member的URL : " + url )
            }
        }
    }
}
